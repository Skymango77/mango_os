<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>여행사: 고객 여정 관리</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Tailwind slate-100 */
        }
        .journey-card {
            border-left: 5px solid;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">여행사: 고객 여정 관리</h1>
        <p class="text-gray-500 mb-6">등록된 고객의 현재 및 예정된 여행 여정을 실시간으로 확인하고 관리합니다.</p>

        <!-- Current Partner Status (for context and security check) -->
        <div class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-lg mb-8">
            <p class="font-semibold">현재 파트너 ID: <span id="current-user-id" class="font-mono text-sm bg-indigo-200 px-2 py-0.5 rounded">로딩 중...</span></p>
            <p class="text-sm">이 화면은 해당 ID에 연결된 고객 여정 데이터만 조회합니다. (데이터 격리 원칙 적용)</p>
        </div>

        <!-- Journey Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-lg journey-card border-indigo-400">
                <p class="text-sm font-medium text-gray-500">현재 진행 중인 여정</p>
                <p id="kpi-in-progress" class="text-4xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg journey-card border-green-400">
                <p class="text-sm font-medium text-gray-500">예정된 여정 수</p>
                <p id="kpi-upcoming" class="text-4xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg journey-card border-red-400">
                <p class="text-sm font-medium text-gray-500">취소/변경 요청 대기</p>
                <p id="kpi-pending-changes" class="text-4xl font-extrabold text-gray-900 mt-1">0</p>
            </div>
        </div>

        <!-- Main Journey List -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">전체 고객 여정 목록 (실시간)</h2>
            
            <!-- List Header -->
            <div class="grid grid-cols-7 gap-4 text-sm font-medium text-gray-500 border-b pb-2 mb-2">
                <div class="col-span-1">여정 ID</div>
                <div class="col-span-1">고객명</div>
                <div class="col-span-1">여행지</div>
                <div class="col-span-1">여행 기간</div>
                <div class="col-span-1">상태</div>
                <div class="col-span-1 text-right">총 금액</div>
                <div class="col-span-1 text-right">액션</div>
            </div>

            <!-- List Body - Items will be injected here -->
            <div id="journeys-list" class="space-y-3">
                <p class="text-gray-500 text-center py-4" id="loading-indicator">데이터를 로드하는 중입니다...</p>
                <!-- Dynamic list items will be injected here by JS -->
            </div>
        </div>
    </div>
    
    <!-- Custom Modal for General Messages -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-semibold text-gray-900 mb-3" id="modal-title">알림</h3>
            <p class="text-gray-700 mb-4" id="modal-message">메시지 내용</p>
            <div class="flex justify-end">
                <button onclick="document.getElementById('message-modal').classList.add('hidden'); document.getElementById('message-modal').classList.remove('flex');"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">확인</button>
            </div>
        </div>
    </div>

    <!-- JOURNEY DETAIL MODAL -->
    <div id="journey-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-3 mb-6">
                <h3 class="text-2xl font-bold text-gray-900">고객 여정 상세 보기</h3>
                <button onclick="document.getElementById('journey-detail-modal').classList.add('hidden'); document.getElementById('journey-detail-modal').classList.remove('flex');"
                        class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div id="detail-content">
                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-indigo-700 mb-2" id="detail-customer-info"></h4>
                    <p class="text-sm text-gray-600">여행 ID: <span id="detail-journey-id" class="font-mono"></span> | 총 금액: <span id="detail-total-amount" class="font-bold"></span></p>
                    <div class="mt-2 flex items-center">
                        <span class="text-gray-600 mr-2">현재 상태:</span>
                        <span id="detail-status-badge" class="status-badge"></span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Component Status -->
                    <div>
                        <h5 class="text-lg font-bold text-gray-800 mb-3 border-b pb-1">핵심 컴포넌트 연결 상태</h5>
                        <div class="space-y-3" id="component-status-list">
                            <!-- Dynamic components status here -->
                        </div>
                    </div>

                    <!-- Local Service & Contact Points -->
                    <div>
                        <h5 class="text-lg font-bold text-gray-800 mb-3 border-b pb-1">현지 서비스 및 접점 정보</h5>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                            <div>
                                <p class="font-medium text-gray-700">현지 가이드 (랜드사)</p>
                                <p id="guide-info" class="text-indigo-600 font-semibold"></p>
                            </div>
                            <div>
                                <p class="font-medium text-gray-700">공항 미팅 장소</p>
                                <p id="meeting-info" class="text-sm text-gray-700"></p>
                            </div>
                            <div>
                                <p class="font-medium text-gray-700">고객 특별 요청</p>
                                <p id="special-request" class="text-sm text-red-500 font-medium"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mt-8 pt-4 border-t">
                <button onclick="showMessage('업데이트 요청', '현지 파트너에게 변경/취소 요청 알림을 보냅니다.');"
                        class="bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition shadow-md mr-3">
                    변경/취소 요청
                </button>
                <button onclick="showMessage('문서 발송', '최종 여정표 및 바우처를 고객에게 발송합니다.');"
                        class="bg-green-500 text-white px-5 py-2 rounded-lg hover:bg-green-600 transition shadow-md">
                    최종 문서 발송
                </button>
            </div>
        </div>
    </div>


    <!-- JavaScript and Firebase Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and State Variables
        let db;
        let auth;
        let userId = null;
        let allJourneys = []; // 여정 데이터를 전역으로 저장하여 상세 보기에서 사용
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mango-travel-portal';
        
        // --- 헬퍼 함수 및 상수 ---
        const formatCurrency = (value) => `₩ ${value.toLocaleString('ko-KR')}`;

        function showMessage(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }

        const STATUS_CLASSES = {
            'Confirmed': 'bg-green-100 text-green-800',
            'Pending': 'bg-yellow-100 text-yellow-800',
            'InProgress': 'bg-indigo-100 text-indigo-800',
            'Cancelled': 'bg-red-100 text-red-800',
        };

        const STATUS_LABELS = {
            'Confirmed': '예약 확정',
            'Pending': '승인 대기',
            'InProgress': '여행 중',
            'Cancelled': '취소됨',
        };

        const COMPONENT_STATUS = {
            'Flight': {
                'Confirmed': { label: '항공권 발권 완료 (E-Ticket)', class: 'bg-green-500' },
                'Pending': { label: '항공권 예약 중', class: 'bg-yellow-500' },
            },
            'Hotel': {
                'Confirmed': { label: '숙소 바우처 확정', class: 'bg-green-500' },
                'Pending': { label: '객실 예약 요청 중', class: 'bg-yellow-500' },
            },
            'Guide': {
                'Confirmed': { label: '현지 가이드 배정 완료', class: 'bg-green-500' },
                'Pending': { label: '가이드 배정 대기 중', class: 'bg-red-500' }, // Critical: Red if not confirmed
            },
        };
        
        // --- UI 업데이트 함수 ---
        function updateJourneysUI(journeys) {
            allJourneys = journeys; // 전역 변수에 데이터 저장
            
            const listEl = document.getElementById('journeys-list');
            const inProgressCountEl = document.getElementById('kpi-in-progress');
            const upcomingCountEl = document.getElementById('kpi-upcoming');
            const pendingChangesEl = document.getElementById('kpi-pending-changes');
            
            // 1. KPI 계산
            const inProgressCount = journeys.filter(j => j.status === 'InProgress').length;
            const upcomingCount = journeys.filter(j => j.status === 'Confirmed' || j.status === 'Pending').length;
            const pendingChanges = journeys.filter(j => j.status === 'Pending').length; 

            inProgressCountEl.textContent = inProgressCount;
            upcomingCountEl.textContent = upcomingCount;
            pendingChangesEl.textContent = pendingChanges;
            
            // 2. 리스트 렌더링
            if (journeys.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-4">등록된 고객 여정 정보가 없습니다.</p>';
            } else {
                listEl.innerHTML = journeys.map(journey => {
                    const statusClass = STATUS_CLASSES[journey.status] || 'bg-gray-100 text-gray-800';
                    const statusLabel = STATUS_LABELS[journey.status] || '알 수 없음';
                    
                    return `
                        <div class="grid grid-cols-7 gap-4 items-center border-b last:border-b-0 py-3 hover:bg-gray-50 transition duration-100">
                            <div class="col-span-1 text-sm font-medium text-indigo-600">${journey.id.substring(0, 8)}...</div>
                            <div class="col-span-1 text-sm text-gray-700">${journey.customerName}</div>
                            <div class="col-span-1 text-sm text-gray-700">${journey.destination}</div>
                            <div class="col-span-1 text-sm text-gray-700">${journey.startDate} ~ ${journey.endDate}</div>
                            <div class="col-span-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                    ${statusLabel}
                                </span>
                            </div>
                            <div class="col-span-1 text-right text-sm font-semibold text-gray-900">${formatCurrency(journey.totalAmount)}</div>
                            <div class="col-span-1 text-right">
                                <button onclick="window.showJourneyDetails('${journey.id}')" 
                                        class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 text-xs px-3 py-1.5 rounded-lg transition font-medium">
                                    상세 보기
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // --- 여정 상세 정보 표시 함수 ---
        window.showJourneyDetails = (journeyId) => {
            const journey = allJourneys.find(j => j.id === journeyId);
            if (!journey) {
                showMessage("오류", "해당 여정 정보를 찾을 수 없습니다.");
                return;
            }

            // 1. 기본 정보 설정
            document.getElementById('detail-customer-info').textContent = `${journey.customerName} 고객님의 ${journey.destination} 여정`;
            document.getElementById('detail-journey-id').textContent = journeyId;
            document.getElementById('detail-total-amount').textContent = formatCurrency(journey.totalAmount);
            
            // 상태 뱃지 업데이트
            const statusClass = STATUS_CLASSES[journey.status] || 'bg-gray-100 text-gray-800';
            const statusLabel = STATUS_LABELS[journey.status] || '알 수 없음';
            const statusBadgeEl = document.getElementById('detail-status-badge');
            statusBadgeEl.textContent = statusLabel;
            statusBadgeEl.className = `status-badge ${statusClass}`;

            // 2. 핵심 컴포넌트 상태 (Mock Data 사용)
            const componentData = [
                { type: 'Flight', status: journey.status === 'Confirmed' || journey.status === 'InProgress' ? 'Confirmed' : 'Pending' },
                { type: 'Hotel', status: journey.status === 'InProgress' ? 'Confirmed' : 'Pending' },
                { type: 'Guide', status: journey.status === 'Confirmed' ? 'Confirmed' : 'Pending' },
                { type: 'Transportation', status: 'Confirmed', label: '현지 교통편 (확정)', detail: 'TGV 예약 (PNR: 9X3D2A)' },
            ];

            const componentListHtml = componentData.map(item => {
                const config = COMPONENT_STATUS[item.type] ? COMPONENT_STATUS[item.type][item.status] : { label: item.detail, class: 'bg-gray-500' };
                const icon = config.class.includes('green') ? '✅' : (config.class.includes('yellow') ? '⚠️' : '❌');
                const detail = item.detail || '';
                const typeLabel = item.type === 'Flight' ? '항공권' : (item.type === 'Hotel' ? '숙박' : (item.type === 'Guide' ? '현지 가이드' : item.type));

                return `
                    <div class="flex items-center justify-between p-3 rounded-lg border">
                        <span class="font-medium text-gray-700">${typeLabel}</span>
                        <div class="flex items-center">
                            <span class="text-xs font-semibold text-white px-2 py-0.5 rounded-full ${config.class}">${icon} ${config.label}</span>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('component-status-list').innerHTML = componentListHtml;

            // 3. 현지 서비스 및 접점 정보 (Mock Data 기반)
            document.getElementById('guide-info').textContent = journey.status === 'Confirmed' 
                ? '가이드: Jean-Pierre (연락처: +33 6 1234 5678)' 
                : '가이드: 배정 대기 중 (최대 3일 전 확정 예정)';
            
            document.getElementById('meeting-info').textContent = journey.status === 'Confirmed' 
                ? '파리 샤를 드 골 공항 (CDG) - 입국장 GATE 2 앞, 이름표(Park) 미팅'
                : '확정 대기 중. 항공편 도착 30분 전 담당자 연락 예정.';

            document.getElementById('special-request').textContent = journey.customerName === '김민지' 
                ? '비건식 요청, 고층 객실 희망' 
                : '요청 사항 없음';

            // 4. 모달 표시
            document.getElementById('journey-detail-modal').classList.remove('hidden');
            document.getElementById('journey-detail-modal').classList.add('flex');
        };

        // --- Firestore Real-time Listener (onSnapshot) ---
        function setupJourneysListener(currentUserId) {
            // Display current userId on UI for verification
            document.getElementById('current-user-id').textContent = currentUserId;

            // Collection path: /artifacts/{appId}/public/data/bookings
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');

            // 쿼리: partnerId가 현재 로그인한 userId와 일치하는 문서만 필터링합니다. (데이터 격리 적용)
            const q = query(collectionRef, where('partnerId', '==', currentUserId));

            // Listen for real-time updates
            onSnapshot(q, (snapshot) => {
                document.getElementById('loading-indicator').classList.add('hidden'); // Hide loading indicator

                const journeys = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    journeys.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                // Firestore에서 받아온 데이터를 ID 기준으로 정렬 (최신 순 또는 시작일 순)
                journeys.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

                console.log(`Loaded ${journeys.length} journeys for partner: ${currentUserId}`);
                updateJourneysUI(journeys);

            }, (error) => {
                console.error("Firestore listen error (Journeys):", error);
                showMessage("데이터 로드 오류", "고객 여정 데이터를 불러오는 중 오류가 발생했습니다: " + error.message);
            });
        }


        // --- Firebase Initialization and Authentication ---
        async function initFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // Enable debug logging

                // Initial Authentication
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up Auth State Listener and initialize app state
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Auth state changed. User ID:", userId);
                        // Start listening to the filtered data for the authenticated user
                        setupJourneysListener(userId); 
                    } else {
                        userId = null;
                        console.error("User logged out or authentication failed.");
                        showMessage("인증 필요", "사용자 인증에 실패했습니다. 데이터를 보려면 로그인을 확인해 주세요.");
                        document.getElementById('journeys-list').innerHTML = '<p class="text-red-500 text-center py-4">인증되지 않은 사용자입니다. 데이터 접근이 거부되었습니다.</p>';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or auth failed:", error);
                showMessage("Firebase 오류", `Firebase 초기화 또는 인증에 실패했습니다: ${error.message}`);
            }
        }

        // --- Initial Setup ---
        window.onload = () => {
            initFirebase();
        };

        // --- Mock Data Insertion (For demonstration) ---
        // 이 함수를 콘솔에서 실행하여 데이터베이스에 테스트 데이터를 삽입할 수 있습니다.
        window.insertMockJourneys = async () => {
             if (!userId) {
                showMessage("오류", "먼저 Firebase 인증이 완료되어야 목업 데이터를 삽입할 수 있습니다.");
                return;
            }
            try {
                const mockJourneys = [
                    { 
                        partnerId: userId, // <<< 현재 로그인한 유저 ID로 설정!
                        customerName: "김민지", 
                        destination: "파리, 프랑스", 
                        startDate: "2025-06-10", 
                        endDate: "2025-06-18", 
                        totalAmount: 4800000, 
                        status: "Confirmed" 
                    },
                    { 
                        partnerId: userId, // <<< 현재 로그인한 유저 ID로 설정!
                        customerName: "이준호", 
                        destination: "제주도, 대한민국", 
                        startDate: "2025-12-24", 
                        endDate: "2025-12-28", 
                        totalAmount: 850000, 
                        status: "Pending" 
                    },
                    { 
                        partnerId: userId, // <<< 현재 로그인한 유저 ID로 설정!
                        customerName: "박서연", 
                        destination: "뉴욕, 미국", 
                        startDate: "2025-04-01", 
                        endDate: "2025-04-08", 
                        totalAmount: 6200000, 
                        status: "InProgress" 
                    },
                    { 
                        partnerId: userId, // <<< 현재 로그인한 유저 ID로 설정!
                        customerName: "최현우", 
                        destination: "방콕, 태국", 
                        startDate: "2025-07-20", 
                        endDate: "2025-07-27", 
                        totalAmount: 2100000, 
                        status: "Confirmed" 
                    },
                ];

                for (const journey of mockJourneys) {
                    // Firebase Emulator의 REST API를 사용하여 문서 추가 (Colab 환경용)
                    const tempId = `mock-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                    await fetch(`https://generativelanguage.googleapis.com/v1beta/projects/firebase-emulator/databases/(default)/documents/artifacts/${appId}/public/data/bookings/${tempId}?key=`, {
                        method: 'PATCH', // PATCH를 사용하여 특정 ID로 설정
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fields: journey })
                    });
                }
                showMessage("성공", "여행사 고객 여정 목업 데이터가 성공적으로 삽입되었습니다. 화면을 확인하세요.");
            } catch (e) {
                console.error("Error adding mock documents: ", e);
                showMessage("실패", "목업 데이터 삽입 중 오류가 발생했습니다. 콘솔을 확인하세요.");
            }
        };

    </script>
</body>
</html>