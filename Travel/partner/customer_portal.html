<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—¬í–‰ ìƒí’ˆ ê²€ìƒ‰ ë° ì˜ˆì•½ í¬í„¸ (ê³ ê° ì˜ë„ ë°˜ì˜)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; /* Tailwind indigo-50 */
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* ê³µí†µ ë·° ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .view-container {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header / Logo and Navigation -->
        <header class="mb-8 p-4 bg-white rounded-xl shadow-lg flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-indigo-700 tracking-tight">
                âœˆï¸ Mango Travel
            </h1>
            <!-- Navigation Buttons -->
            <div class="flex space-x-2">
                <button id="search-view-btn" onclick="showView('search')" 
                        class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-indigo-700 transition">
                    ìƒí’ˆ ê²€ìƒ‰
                </button>
                
                <!-- NEW: Cart Button -->
                <button id="cart-view-btn" onclick="showView('cart')" 
                        class="relative bg-pink-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-pink-600 transition">
                    ğŸ›’ ì¥ë°”êµ¬ë‹ˆ (<span id="cart-count">0</span>)
                </button>
                
                <button id="bookings-view-btn" onclick="showView('bookings')" 
                        class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-indigo-200 transition">
                    ë‚´ ì˜ˆì•½ ë³´ê¸°
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- 1. Search View -->
            <div id="search-view" class="view-container">
                <!-- Search Type Selector (Updated - Customer Intent Focused) -->
                <div class="flex justify-center mb-6">
                    <div class="inline-flex rounded-full shadow-lg bg-white p-1 flex-wrap justify-center">
                        <button id="search-type-package" onclick="setSearchType('package')"
                                class="px-5 py-2 text-sm font-medium rounded-full transition duration-150 text-gray-700 hover:bg-indigo-50 min-w-[120px]">
                            ğŸ›ï¸ íŒ¨í‚¤ì§€ ìƒí’ˆ
                        </button>
                        <button id="search-type-accommodation" onclick="setSearchType('accommodation')"
                                class="px-5 py-2 text-sm font-medium rounded-full transition duration-150 text-gray-700 hover:bg-indigo-50 min-w-[120px]">
                            ğŸ¨ ìˆ™ì†Œë§Œ ê²€ìƒ‰
                        </button>
                        <button id="search-type-flight" onclick="setSearchType('flight')"
                                class="px-5 py-2 text-sm font-medium rounded-full transition duration-150 text-gray-700 hover:bg-indigo-50 min-w-[120px]">
                            âœˆï¸ í•­ê³µê¶Œë§Œ ê²€ìƒ‰
                        </button>
                        <button id="search-type-rental-car" onclick="setSearchType('rental_car')"
                                class="px-5 py-2 text-sm font-medium rounded-full transition duration-150 text-gray-700 hover:bg-indigo-50 min-w-[120px]">
                            ğŸš— ë Œí„°ì¹´ë§Œ ê²€ìƒ‰
                        </button>
                    </div>
                </div>

                <!-- Search Form -->
                <div class="bg-white p-6 md:p-8 rounded-xl card-shadow mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4" id="search-form-title">íŒ¨í‚¤ì§€ ìƒí’ˆ ê²€ìƒ‰</h2>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        
                        <!-- 1. ìƒí’ˆë³„ ë™ì  ì…ë ¥ (Location / Route / Pickup Location) -->
                        <div class="md:col-span-2">
                            <!-- Package & Accommodation Inputs (Destination) -->
                            <div id="accommodation-inputs">
                                <label for="destination" class="block text-sm font-medium text-gray-700 mb-1">ëª©ì ì§€</label>
                                <select id="destination" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50">
                                    <option value="busan">ë¶€ì‚° (Busan)</option>
                                    <option value="seoul" disabled>ì„œìš¸ (ì¤€ë¹„ ì¤‘)</option>
                                    <option value="jeju">ì œì£¼ (Jeju)</option>
                                </select>
                            </div>
                            <!-- Flight Inputs (Origin & Destination) -->
                            <div id="flight-inputs" class="hidden grid grid-cols-2 gap-2">
                                <div>
                                    <label for="origin" class="block text-sm font-medium text-gray-700 mb-1">ì¶œë°œì§€</label>
                                    <select id="origin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50">
                                        <option value="gimpo">ê¹€í¬ (GMP)</option>
                                        <option value="incheon" disabled>ì¸ì²œ (ICN)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="flight-destination" class="block text-sm font-medium text-gray-700 mb-1">ë„ì°©ì§€</label>
                                    <select id="flight-destination" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50">
                                        <option value="jeju">ì œì£¼ (CJU)</option>
                                        <option value="busan">ê¹€í•´ (PUS)</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Rental Car Inputs (Pickup Location) -->
                            <div id="rental-car-inputs" class="hidden">
                                <label for="pickup-location" class="block text-sm font-medium text-gray-700 mb-1">í”½ì—… ì¥ì†Œ</label>
                                <select id="pickup-location" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50">
                                    <option value="busan">ë¶€ì‚° ê¹€í•´ê³µí•­</option>
                                    <option value="jeju">ì œì£¼ êµ­ì œê³µí•­</option>
                                    <option value="seoul" disabled>ì„œìš¸ì—­ (ì¤€ë¹„ ì¤‘)</option>
                                </select>
                            </div>
                        </div>


                        <!-- 2. ì²´í¬ì¸/ì¶œë°œ/í”½ì—… ë‚ ì§œ ë° ì‹œê°„ -->
                        <div class="md:col-span-1">
                            <label for="check-in-date" class="block text-sm font-medium text-gray-700 mb-1" id="date-label-start">ì¶œë°œ ë‚ ì§œ</label>
                            <input type="date" id="check-in-date" onchange="updateCheckoutDate()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Rental Car Time Input -->
                            <input type="time" id="pickup-time" value="10:00" class="hidden w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mt-2">
                        </div>
                        <!-- 3. ì²´í¬ì•„ì›ƒ/ë„ì°©/ë°˜ë‚© ë‚ ì§œ ë° ì‹œê°„ -->
                        <div class="md:col-span-1">
                            <label for="check-out-date" class="block text-sm font-medium text-gray-700 mb-1" id="date-label-end">ë„ì°© ë‚ ì§œ</label>
                            <input type="date" id="check-out-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Rental Car Time Input -->
                            <input type="time" id="return-time" value="10:00" class="hidden w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mt-2">
                        </div>
                        <!-- 4. ê²€ìƒ‰ ë²„íŠ¼ -->
                        <div class="flex items-end md:col-span-1">
                            <button onclick="searchProducts()"
                                    class="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition shadow-md font-bold">
                                ğŸ” ê²€ìƒ‰í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search Results -->
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ê²€ìƒ‰ ê²°ê³¼</h2>
                    
                    <div id="loading-indicator" class="hidden text-center py-12">
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-3"></div>
                        <p class="text-indigo-600 font-medium">ìƒí’ˆ ì¬ê³ ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>

                    <div id="results-container" class="space-y-6">
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg">
                            <p class="font-semibold">ğŸ›ï¸ íŒ¨í‚¤ì§€ ê²€ìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”!</p>
                            <p class="text-sm">ì›í•˜ëŠ” ìƒí’ˆ ìœ í˜•ì„ ì„ íƒí•˜ê³  ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ê²€ìƒ‰í•´ ë³´ì„¸ìš”.</p>
                        </div>
                        <!-- Dynamic results will be injected here -->
                    </div>
                </div>
            </div>
            
            <!-- 2. Cart View (NEW) -->
            <div id="cart-view" class="view-container hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ëª©ë¡</h2>
                
                <div class="bg-white p-6 rounded-xl card-shadow mb-6 flex justify-between items-center flex-wrap gap-4">
                    <p class="text-xl font-semibold text-gray-700">ì¥ë°”êµ¬ë‹ˆ ì´ì•¡: <span id="cart-total-price" class="text-pink-600 font-extrabold">0 KRW</span></p>
                    <div class="flex space-x-3">
                        <button onclick="shareCart()" 
                                class="bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-600 transition shadow-md disabled:bg-gray-400"
                                id="share-cart-btn" disabled>
                            ğŸ”— ì¥ë°”êµ¬ë‹ˆ ê³µìœ í•˜ê¸°
                        </button>
                        <button onclick="clearCart()" 
                                class="bg-red-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-600 transition shadow-md disabled:bg-gray-400">
                            ğŸ—‘ï¸ ë¹„ìš°ê¸°
                        </button>
                    </div>
                </div>

                <div id="cart-list" class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-lg">
                        <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>

            <!-- 3. Bookings View (Existing) -->
            <div id="bookings-view" class="view-container hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ë‚´ ì˜ˆì•½ ëª©ë¡</h2>
                <p class="text-sm text-gray-600 mb-6">í˜„ì¬ ì‚¬ìš©ì ID: <code id="user-id-display" class="font-mono text-xs bg-gray-200 p-1 rounded break-all"></code></p>
                
                <div id="bookings-list" class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-lg">
                        <p>ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Message Modal (for alerts) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-lg font-semibold text-gray-900 mb-3" id="modal-title">ì•Œë¦¼</h3>
            <p class="text-gray-700 mb-4" id="modal-message">ë©”ì‹œì§€ ë‚´ìš©</p>
            <div class="flex justify-end">
                <button onclick="document.getElementById('message-modal').classList.add('hidden'); document.getElementById('message-modal').classList.remove('flex');"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">í™•ì¸</button>
            </div>
        </div>
    </div>


    <!-- JavaScript and Firebase Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, addDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and State Variables
        let db;
        let auth;
        let userId = null;
        let unsubscribeBookings = null; // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í•´ì œ í•¨ìˆ˜
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mango-travel-portal';
        
        // NEW: Cart State
        let cart = [];
        
        // **ê³ ê° ì˜ë„ ë°˜ì˜: ì´ˆê¸° ê²€ìƒ‰ ìœ í˜•ì„ íŒ¨í‚¤ì§€ë¡œ ì„¤ì •**
        let currentSearchType = 'package'; // 'package', 'accommodation', 'flight', 'rental_car'

        // --- Mock Data ---
        const MOCK_FLIGHT_PRODUCTS = [
            { id: 'FL001', airline: 'Mango Air', flightNumber: 'MA101', route: 'GMP â†’ CJU', basePrice: 85000, duration: '1ì‹œê°„ 5ë¶„' },
            { id: 'FL002', airline: 'FlyKorea', flightNumber: 'FK305', route: 'GMP â†’ CJU', basePrice: 98000, duration: '1ì‹œê°„ 10ë¶„' },
            { id: 'FL003', airline: 'Peach Airlines', flightNumber: 'PA777', route: 'GMP â†’ CJU', basePrice: 75000, duration: '1ì‹œê°„ 15ë¶„' },
        ];
        
        const MOCK_CAR_PRODUCTS = [
            { id: 'RC001', model: 'ì•„ë°˜ë–¼ AD (ì¤€ì¤‘í˜•)', company: 'Happy Rent', dailyPrice: 40000, fuel: 'ê°€ì†”ë¦°' },
            { id: 'RC002', model: 'K5 (ì¤‘í˜•)', company: 'Quick Car', dailyPrice: 55000, fuel: 'LPG' },
        ];

        // --- ìœ í‹¸ë¦¬í‹° ë° UI í—¬í¼ í•¨ìˆ˜ ---
        
        function showMessage(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }

        function toggleLoading(show) {
            document.getElementById('loading-indicator').classList.toggle('hidden', !show);
            if (show) {
                document.getElementById('results-container').innerHTML = ''; 
            }
        }

        function parseDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getDurationInDays(startDateString, endDateString) {
            const start = parseDate(startDateString);
            const end = parseDate(endDateString);
            const diffTime = Math.abs(end.getTime() - start.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(1, diffDays); 
        }

        window.updateCheckoutDate = () => {
            const checkInInput = document.getElementById('check-in-date');
            const checkOutInput = document.getElementById('check-out-date');
            
            if (checkInInput.value) {
                const checkInDate = parseDate(checkInInput.value);
                const nextDay = new Date(checkInDate);

                // íŒ¨í‚¤ì§€, ìˆ™ë°•ì€ +1ì¼ (1ë°•)
                if (currentSearchType === 'accommodation' || currentSearchType === 'package') {
                    nextDay.setDate(checkInDate.getDate() + 1);
                } else {
                    // í•­ê³µ, ë Œí„°ì¹´ëŠ” ë‹¹ì¼ í¬í•¨ ê°€ëŠ¥
                    nextDay.setDate(checkInDate.getDate());
                }
                
                const nextDayStr = formatDate(nextDay);
                checkOutInput.value = nextDayStr;
                checkOutInput.min = nextDayStr;
            }
        };

        function getDateRange(startDateString, endDateString) {
            const dates = [];
            let currentDate = parseDate(startDateString);
            const endDate = parseDate(endDateString);

            while (currentDate < endDate) {
                const dateStr = formatDate(currentDate);
                dates.push(dateStr);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        // --- Cart Management ---

        function updateCartCount() {
            document.getElementById('cart-count').textContent = cart.length;
            document.getElementById('share-cart-btn').disabled = cart.length === 0;
            
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            document.getElementById('cart-total-price').textContent = `${total.toLocaleString('ko-KR')} KRW`;
        }

        window.addToCart = (productDataJson) => {
            try {
                const product = JSON.parse(productDataJson);
                // ì¤‘ë³µ ì²´í¬ ë¡œì§ (ê°„ë‹¨í•˜ê²Œ IDì™€ íƒ€ì…ì´ ê°™ìœ¼ë©´ ì¤‘ë³µìœ¼ë¡œ ê°„ì£¼)
                const isDuplicate = cart.some(item => 
                    item.productId === product.productId && item.productType === product.productType
                );

                if (isDuplicate) {
                    showMessage("ì•Œë¦¼", "ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆì…ë‹ˆë‹¤.");
                    return;
                }

                cart.push(product);
                updateCartCount();
                showMessage("ì¥ë°”êµ¬ë‹ˆ", `${product.productName} ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤!`);
            } catch (error) {
                console.error("Failed to add to cart:", error);
                showMessage("ì˜¤ë¥˜", "ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì„ ë‹´ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };
        
        window.removeFromCart = (index) => {
            cart.splice(index, 1);
            updateCartCount();
            renderCart();
            showMessage("ì‚­ì œ ì™„ë£Œ", "ì¥ë°”êµ¬ë‹ˆì—ì„œ ìƒí’ˆì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
        };

        window.clearCart = () => {
            cart = [];
            updateCartCount();
            renderCart();
            showMessage("ë¹„ìš°ê¸° ì™„ë£Œ", "ì¥ë°”êµ¬ë‹ˆì˜ ëª¨ë“  ìƒí’ˆì„ ë¹„ì› ìŠµë‹ˆë‹¤.");
        };

        window.renderCart = () => {
            const container = document.getElementById('cart-list');
            container.innerHTML = '';

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-lg">
                        <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ê²€ìƒ‰ íƒ­ì—ì„œ ìƒí’ˆì„ ë‹´ì•„ë³´ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            cart.forEach((item, index) => {
                const isFlight = item.productType === 'flight';
                const isRentalCar = item.productType === 'rental_car';
                const isPackage = item.productType === 'package';
                
                let icon, period, priceColor, details;
                
                if (isFlight) {
                    icon = 'âœˆï¸';
                    priceColor = 'text-green-600';
                    period = `ì¶œë°œì¼: ${item.checkIn}`;
                    details = `ë…¸ì„ : ${item.metadata?.route} | ì†Œìš” ì‹œê°„: ${item.metadata?.duration}`;
                } else if (isRentalCar) {
                    icon = 'ğŸš—';
                    priceColor = 'text-orange-600';
                    period = `í”½ì—…: ${item.checkIn} â†’ ë°˜ë‚©: ${item.checkOut} (${item.days}ì¼)`;
                    details = `ì°¨ëŸ‰: ${item.metadata?.model} | ì—…ì²´: ${item.metadata?.company}`;
                } else if (isPackage) {
                    icon = 'ğŸ›ï¸';
                    priceColor = 'text-fuchsia-600';
                    period = `ì¶œë°œ: ${item.checkIn} â†’ ë„ì°©: ${item.checkOut} (${item.nights}ë°•)`;
                    details = `í•­ê³µ+ìˆ™ì†Œ íŒ¨í‚¤ì§€`;
                } else {
                    icon = 'ğŸ¨';
                    priceColor = 'text-indigo-600';
                    period = `ì²´í¬ì¸: ${item.checkIn} â†’ ì²´í¬ì•„ì›ƒ: ${item.checkOut} (${item.nights}ë°•)`;
                    details = `íŒŒíŠ¸ë„ˆ: ${item.partnerId}`;
                }

                const itemHtml = `
                    <div class="bg-white p-5 rounded-xl card-shadow flex justify-between items-center space-x-4">
                        <div class="flex-grow">
                            <h3 class="text-lg font-bold text-gray-900">${icon} ${item.productName}</h3>
                            <p class="text-sm text-gray-600 mt-1">${period}</p>
                            <p class="text-xs text-gray-400 mt-1">${details}</p>
                        </div>
                        <div class="flex-shrink-0 text-right">
                            <p class="text-xl font-extrabold ${priceColor}">${item.totalPrice.toLocaleString('ko-KR')} KRW</p>
                            <div class="flex space-x-2 mt-2">
                                <button onclick='bookProduct("${JSON.stringify(item).replace(/"/g, '&quot;')}", true, ${index})'
                                        class="bg-orange-500 text-white px-4 py-1 text-sm rounded-lg hover:bg-orange-600 transition">
                                    ì˜ˆì•½í•˜ê¸°
                                </button>
                                <button onclick='removeFromCart(${index})'
                                        class="bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-lg hover:bg-gray-300 transition">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHtml;
            });
            updateCartCount();
        };

        /**
         * ì¥ë°”êµ¬ë‹ˆ ê³µìœ  ê¸°ëŠ¥ (Firebase Public Collection ì‚¬ìš©)
         */
        window.shareCart = async () => {
            if (cart.length === 0) {
                showMessage("ì˜¤ë¥˜", "ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìƒí’ˆì„ ë‹´ì•„ì£¼ì„¸ìš”.");
                return;
            }
            if (!db || !userId) {
                showMessage("ì˜¤ë¥˜", "ì¸ì¦ ì •ë³´ê°€ ë¶€ì¡±í•˜ì—¬ ê³µìœ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                document.getElementById('share-cart-btn').textContent = "ê³µìœ  ì¤‘...";
                document.getElementById('share-cart-btn').disabled = true;

                // 1. ê³µìš© ì»¬ë ‰ì…˜ ê²½ë¡œ: /artifacts/{appId}/public/data/shared_carts
                const sharedCartsRef = collection(db, 'artifacts', appId, 'public', 'data', 'shared_carts');
                
                const cartDataToSave = {
                    ownerId: userId,
                    createdAt: new Date().toISOString(),
                    items: cart,
                    totalPrice: cart.reduce((sum, item) => sum + item.totalPrice, 0)
                };

                // 2. Firestoreì— ì¥ë°”êµ¬ë‹ˆ ë°ì´í„° ì €ì¥
                const docRef = await addDoc(sharedCartsRef, cartDataToSave);
                const shareId = docRef.id;

                // 3. ê³µìœ  ë§í¬ ìƒì„± (í˜„ì¬ í™˜ê²½ URLì€ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ Mock URL ì‚¬ìš©)
                // ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” 'https://yourportal.com/share?id=' + shareId í˜•íƒœê°€ ë©ë‹ˆë‹¤.
                const mockBaseUrl = "https://mango.travel/shared-cart-preview";
                const shareUrl = `${mockBaseUrl}?shareId=${shareId}`;

                // 4. í´ë¦½ë³´ë“œì— ë³µì‚¬ (document.execCommand('copy') ì‚¬ìš©)
                const tempInput = document.createElement('textarea');
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                showMessage(
                    "ğŸ”— ì¥ë°”êµ¬ë‹ˆ ê³µìœ  ì™„ë£Œ!",
                    `ì¥ë°”êµ¬ë‹ˆ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. (Share ID: ${shareId})\n\në™í–‰ì¸ì—ê²Œ ì´ ë§í¬ë¥¼ ì „ë‹¬í•˜ì„¸ìš”: ${shareUrl}`
                );

            } catch (error) {
                console.error("Failed to share cart:", error);
                showMessage("ê³µìœ  ì‹¤íŒ¨", "ì¥ë°”êµ¬ë‹ˆë¥¼ ê³µìœ í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                document.getElementById('share-cart-btn').textContent = "ğŸ”— ì¥ë°”êµ¬ë‹ˆ ê³µìœ í•˜ê¸°";
                document.getElementById('share-cart-btn').disabled = cart.length === 0;
            }
        };

        // --- UI View Control ---

        /**
         * ê²€ìƒ‰ íƒ€ì… ë³€ê²½ (íŒ¨í‚¤ì§€ <-> ìˆ™ë°• <-> í•­ê³µê¶Œ <-> ë Œí„°ì¹´)
         */
        window.setSearchType = (type) => {
            currentSearchType = type;
            const isAccommodation = type === 'accommodation';
            const isFlight = type === 'flight';
            const isRentalCar = type === 'rental_car';
            const isPackage = type === 'package'; // New package type

            document.getElementById('search-form-title').textContent = 
                isPackage ? 'íŒ¨í‚¤ì§€ ìƒí’ˆ ê²€ìƒ‰' : 
                isAccommodation ? 'ìˆ™ì†Œë§Œ ê²€ìƒ‰' : 
                isFlight ? 'í•­ê³µê¶Œë§Œ ê²€ìƒ‰' :
                'ë Œí„°ì¹´ë§Œ ê²€ìƒ‰'; 

            // Input Visibility
            const useDestinationSelect = isPackage || isAccommodation;
            document.getElementById('accommodation-inputs').classList.toggle('hidden', !useDestinationSelect);
            document.getElementById('flight-inputs').classList.toggle('hidden', !(isFlight));
            document.getElementById('rental-car-inputs').classList.toggle('hidden', !(isRentalCar));

            // Date Labels & Time Inputs
            document.getElementById('date-label-start').textContent = (isAccommodation || isPackage) ? 'ì²´í¬ì¸/ì¶œë°œ ë‚ ì§œ' : isFlight ? 'ì¶œë°œ ë‚ ì§œ' : 'í”½ì—… ë‚ ì§œ';
            document.getElementById('date-label-end').textContent = (isAccommodation || isPackage) ? 'ì²´í¬ì•„ì›ƒ/ë„ì°© ë‚ ì§œ' : isFlight ? 'ë„ì°© ë‚ ì§œ' : 'ë°˜ë‚© ë‚ ì§œ';
            
            document.getElementById('pickup-time').classList.toggle('hidden', !isRentalCar);
            document.getElementById('return-time').classList.toggle('hidden', !isRentalCar);

            // Button Style Update
            const setBtnStyle = (btnId, isActive) => {
                const btn = document.getElementById(btnId);
                btn.classList.toggle('bg-indigo-600', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('text-gray-700', !isActive);
                btn.classList.toggle('hover:bg-indigo-50', !isActive);
            };

            setBtnStyle('search-type-package', isPackage);
            setBtnStyle('search-type-accommodation', isAccommodation);
            setBtnStyle('search-type-flight', isFlight);
            setBtnStyle('search-type-rental-car', isRentalCar);

            // Result Reset
            document.getElementById('results-container').innerHTML = `
                <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg">
                    <p class="font-semibold">${document.getElementById('search-form-title').textContent}ì„(ë¥¼) ì‹œì‘í•˜ì„¸ìš”!</p>
                    <p class="text-sm">ìœ„ ê²€ìƒ‰ì°½ì—ì„œ ë‚ ì§œ ë° ì¡°ê±´ì„ ì„ íƒí•˜ê³  'ê²€ìƒ‰í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.</p>
                </div>
            `;
            initializeUI(); 
        };

        window.showView = (viewName) => {
            const views = {
                'search': document.getElementById('search-view'),
                'bookings': document.getElementById('bookings-view'),
                'cart': document.getElementById('cart-view')
            };
            const searchBtn = document.getElementById('search-view-btn');
            const bookingsBtn = document.getElementById('bookings-view-btn');
            const cartBtn = document.getElementById('cart-view-btn');

            Object.values(views).forEach(v => v.classList.add('hidden'));

            const setActiveButton = (button, isActive, activeColor, inactiveColor) => {
                button.classList.toggle(activeColor, isActive);
                button.classList.toggle('text-white', isActive);
                button.classList.toggle(inactiveColor, !isActive);
                button.classList.toggle('text-indigo-700', inactiveColor.includes('indigo'));
            };
            
            // Reset all buttons to inactive state
            setActiveButton(searchBtn, false, 'bg-indigo-600', 'bg-indigo-100');
            setActiveButton(bookingsBtn, false, 'bg-indigo-600', 'bg-indigo-100');
            setActiveButton(cartBtn, false, 'bg-pink-600', 'bg-pink-500'); // Cart uses pink

            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
                
                if (viewName === 'search') {
                    setActiveButton(searchBtn, true, 'bg-indigo-600', 'bg-indigo-100');
                } else if (viewName === 'bookings') {
                    setActiveButton(bookingsBtn, true, 'bg-indigo-600', 'bg-indigo-100');
                    if (userId && !unsubscribeBookings) { loadMyBookings(); }
                } else if (viewName === 'cart') { // NEW Cart View Logic
                    setActiveButton(cartBtn, true, 'bg-pink-600', 'bg-pink-500');
                    renderCart();
                }
            }
        };

        // --- ì˜ˆì•½ ëª©ë¡ ë¡œì§ (ê¸°ì¡´ ìœ ì§€) ---
        
        function loadMyBookings() {
            if (!db || !userId) {
                console.error("Database or User ID not available for loading bookings.");
                return;
            }
            
            if (unsubscribeBookings) {
                unsubscribeBookings();
                unsubscribeBookings = null;
            }

            const bookingsPath = ['artifacts', appId, 'users', userId, 'bookings'];
            const bookingsCollectionRef = collection(db, ...bookingsPath);
            const bookingsListContainer = document.getElementById('bookings-list');
            
            unsubscribeBookings = onSnapshot(bookingsCollectionRef, (snapshot) => {
                const bookings = [];
                snapshot.forEach(doc => {
                    bookings.push({ id: doc.id, ...doc.data() });
                });
                
                bookings.sort((a, b) => new Date(b.bookingDate) - new Date(a.bookingDate));

                renderBookingsList(bookings);
            }, (error) => {
                console.error("Error listening to bookings:", error);
                bookingsListContainer.innerHTML = `<div class="bg-red-50 border-l-4 border-red-500 text-red-800 p-4 rounded-lg">ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            });
        }

        function renderBookingsList(bookings) {
            const container = document.getElementById('bookings-list');
            container.innerHTML = ''; 

            if (bookings.length === 0) {
                container.innerHTML = `
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-6 rounded-lg">
                        <p class="font-semibold">ì•„ì§ ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-sm">ìƒí’ˆ ê²€ìƒ‰ íƒ­ì—ì„œ ì›í•˜ëŠ” ìƒí’ˆì„ ì˜ˆì•½í•´ ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }

            bookings.forEach(booking => {
                const isFlight = booking.productType === 'flight';
                const isRentalCar = booking.productType === 'rental_car';
                const isPackage = booking.productType === 'package';

                const statusClass = booking.status === 'PENDING' ? 'bg-yellow-500' : 'bg-green-500';
                const statusText = booking.status === 'PENDING' ? 'ì˜ˆì•½ ëŒ€ê¸°' : 'ì˜ˆì•½ í™•ì •';
                const bookingTime = booking.bookingDate ? new Date(booking.bookingDate).toLocaleDateString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                
                let title, details, period, icon, priceColor;

                if (isFlight) {
                    icon = 'âœˆï¸';
                    title = `${booking.metadata?.airline || 'í•­ê³µì‚¬ ì •ë³´ ì—†ìŒ'} (${booking.metadata?.flightNumber})`;
                    details = `ë…¸ì„ : ${booking.metadata?.route} | ì†Œìš” ì‹œê°„: ${booking.metadata?.duration}`;
                    period = `ì¶œë°œì¼: ${booking.checkIn}`;
                    priceColor = 'text-green-600';
                } else if (isRentalCar) {
                    icon = 'ğŸš—';
                    title = booking.productName || 'ë Œí„°ì¹´ ì •ë³´ ì—†ìŒ';
                    details = `ì—…ì²´: ${booking.metadata?.company || booking.partnerId} | ì—°ë£Œ: ${booking.metadata?.fuel}`;
                    period = `í”½ì—…: ${booking.checkIn} ${booking.metadata?.pickupTime} â†’ ë°˜ë‚©: ${booking.checkOut} ${booking.metadata?.returnTime} (${booking.days}ì¼)`;
                    priceColor = 'text-orange-600';
                } else if (isPackage) {
                    icon = 'ğŸ›ï¸';
                    title = booking.productName || 'íŒ¨í‚¤ì§€ ì •ë³´ ì—†ìŒ';
                    details = `í•­ê³µ: ${booking.metadata?.flightName} | ìˆ™ì†Œ: ${booking.metadata?.accommodationName}`;
                    period = `ì¶œë°œ: ${booking.checkIn} â†’ ë„ì°©: ${booking.checkOut} (${booking.nights}ë°•)`;
                    priceColor = 'text-fuchsia-600';
                } else { // Accommodation
                    icon = 'ğŸ¨';
                    title = booking.productName || 'ê°ì‹¤ ì •ë³´ ì—†ìŒ';
                    details = `íŒŒíŠ¸ë„ˆ ID: ${booking.partnerId}`;
                    period = `ì²´í¬ì¸: ${booking.checkIn} â†’ ì²´í¬ì•„ì›ƒ: ${booking.checkOut} (${booking.nights}ë°•)`;
                    priceColor = 'text-indigo-600';
                }

                const bookingItem = document.createElement('div');
                bookingItem.className = 'bg-white p-5 rounded-xl card-shadow flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0';
                
                bookingItem.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">${icon} ${title}</h3>
                        <p class="text-sm text-gray-600 mt-1">
                            <span class="font-semibold">${period}</span>
                        </p>
                        <p class="text-xs text-gray-400 mt-1">${details}</p>
                        <p class="text-xs text-gray-400 mt-1">ì˜ˆì•½ì¼: ${bookingTime} | ì˜ˆì•½ ID: ${booking.id.substring(0, 8)}</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="px-3 py-1 text-xs font-bold text-white rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                        <p class="text-2xl font-extrabold ${priceColor}">
                            ${booking.totalPrice.toLocaleString('ko-KR')} KRW
                        </p>
                    </div>
                `;
                container.appendChild(bookingItem);
            });
        }
        
        // --- ë©”ì¸ ê²€ìƒ‰ ë¡œì§ ---

        window.searchProducts = async () => {
            if (currentSearchType === 'package') {
                await searchPackages();
            } else if (currentSearchType === 'accommodation') {
                await searchAccommodation();
            } else if (currentSearchType === 'flight') {
                await searchFlights();
            } else if (currentSearchType === 'rental_car') {
                await searchRentalCars();
            }
        }
        // ... (searchPackages, searchAccommodation, searchFlights, searchRentalCars functions are unchanged) ...
        // [Immersive content redacted for brevity.]

        async function searchPackages() {
             if (!db || !userId) {
                showMessage("ì˜¤ë¥˜", "Firebase ì—°ê²° ë˜ëŠ” ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const checkInDate = document.getElementById('check-in-date').value;
            const checkOutDate = document.getElementById('check-out-date').value;
            const destination = document.getElementById('destination').value;
            
            if (!checkInDate || !checkOutDate) {
                showMessage("í•„ìˆ˜ ì…ë ¥", "ì¶œë°œ ë‚ ì§œì™€ ë„ì°© ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                return;
            }
            
            const checkIn = parseDate(checkInDate);
            const checkOut = parseDate(checkOutDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            if (checkIn < today || checkOut < today) {
                showMessage("ë‚ ì§œ ì˜¤ë¥˜", "ì„ íƒí•˜ì‹  ë‚ ì§œëŠ” ì˜¤ëŠ˜ ë‚ ì§œ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            if (checkIn >= checkOut) {
                showMessage("ë‚ ì§œ ì˜¤ë¥˜", "ë„ì°© ë‚ ì§œëŠ” ì¶œë°œ ë‚ ì§œë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            toggleLoading(true);
            const datesToBook = getDateRange(checkInDate, checkOutDate);
            const totalNights = datesToBook.length;
            
            try {
                // Mock Flight Data for Package (GMP -> CJU/PUS depending on destination)
                const routeName = destination === 'jeju' ? 'GMP â†’ CJU' : 'GMP â†’ PUS';
                const flightResults = MOCK_FLIGHT_PRODUCTS
                    .filter(f => f.route.includes(routeName.split('â†’').map(s => s.trim()).join(' â†’ ')))
                    .map(f => ({
                        flight: f,
                        price: f.basePrice + (Math.floor(Math.random() * 20000))
                    }));

                // Get Room Types (Same as Accommodation search)
                const roomTypesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'hotel_room_types');
                const roomTypesSnapshot = await getDocs(roomTypesCollectionRef);
                const roomTypesMap = {};
                roomTypesSnapshot.forEach(doc => {
                    roomTypesMap[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                // Get Hotel Inventory for all nights
                const inventoryCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'hotel_inventory');
                const inventorySnapshot = await getDocs(inventoryCollectionRef);

                const roomAvailability = {}; 
                inventorySnapshot.forEach(doc => {
                    const data = doc.data();
                    const docDate = data.date;
                    if (datesToBook.includes(docDate)) {
                        const key = `${data.roomId}_${data.partnerId}`;
                        
                        if (!roomAvailability[key]) {
                            roomAvailability[key] = {
                                roomId: data.roomId,
                                roomType: roomTypesMap[data.roomId] || null, 
                                minInventory: Infinity, 
                                totalPrice: 0, 
                                datesFound: 0, 
                            };
                        }
                        roomAvailability[key].minInventory = Math.min(roomAvailability[key].minInventory, data.inventory);
                        roomAvailability[key].totalPrice += data.price;
                        roomAvailability[key].datesFound += 1;
                    }
                });
                
                // 3. Combine Flights and Available Rooms into Packages
                const availableRooms = Object.values(roomAvailability)
                    .filter(item => item.roomType && item.datesFound === totalNights && item.minInventory > 0)
                    .sort((a, b) => a.totalPrice - b.totalPrice); 

                const finalPackages = [];
                let packageIndex = 1;

                // Create packages by combining the best flights and rooms
                for (let i = 0; i < Math.min(flightResults.length, 3); i++) { // Limit flights for simplicity
                    for (let j = 0; j < Math.min(availableRooms.length, 3); j++) { // Limit rooms
                        const flight = flightResults[i];
                        const room = availableRooms[j];

                        const packagePrice = flight.price + room.totalPrice;
                        
                        finalPackages.push({
                            productType: 'package',
                            id: `PKG${packageIndex++}`,
                            name: `[${flight.flight.airline}] + ${room.roomType.name}`,
                            partnerId: 'MangoBundle',
                            metadata: {
                                flightName: `${flight.flight.airline} ${flight.flight.flightNumber}`,
                                accommodationName: room.roomType.name,
                                flightPrice: flight.price,
                                accommodationPrice: room.totalPrice,
                                route: flight.flight.route,
                                nights: totalNights,
                                remaining: Math.min(room.minInventory, 5) // Mock remaining count
                            },
                            totalPrice: packagePrice,
                            averagePrice: Math.round(packagePrice / totalNights),
                            nights: totalNights
                        });
                    }
                }

                // 4. Final render
                renderResults(finalPackages.sort((a, b) => a.totalPrice - b.totalPrice), checkInDate, checkOutDate, totalNights);
                
            } catch (error) {
                console.error("Package search failed:", error);
                showMessage("ê²€ìƒ‰ ì˜¤ë¥˜", "íŒ¨í‚¤ì§€ ìƒí’ˆì„ ê²€ìƒ‰í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                toggleLoading(false);
            }
        }


        /**
         * ìˆ™ë°• ìƒí’ˆ ê²€ìƒ‰ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        async function searchAccommodation() {
            if (!db || !userId) {
                showMessage("ì˜¤ë¥˜", "Firebase ì—°ê²° ë˜ëŠ” ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const checkInDate = document.getElementById('check-in-date').value;
            const checkOutDate = document.getElementById('check-out-date').value;
            
            if (!checkInDate || !checkOutDate) {
                showMessage("í•„ìˆ˜ ì…ë ¥", "ì²´í¬ì¸ ë‚ ì§œì™€ ì²´í¬ì•„ì›ƒ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                return;
            }
            
            const checkIn = parseDate(checkInDate);
            const checkOut = parseDate(checkOutDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            if (checkIn < today || checkOut < today) {
                showMessage("ë‚ ì§œ ì˜¤ë¥˜", "ì„ íƒí•˜ì‹  ë‚ ì§œëŠ” ì˜¤ëŠ˜ ë‚ ì§œ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            if (checkIn >= checkOut) {
                showMessage("ë‚ ì§œ ì˜¤ë¥˜", "ì²´í¬ì•„ì›ƒ ë‚ ì§œëŠ” ì²´í¬ì¸ ë‚ ì§œë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            toggleLoading(true);
            const datesToBook = getDateRange(checkInDate, checkOutDate);
            const totalNights = datesToBook.length;
            
            try {
                // 1. ëª¨ë“  ê°ì‹¤ íƒ€ì… ê¸°ë³¸ ì •ë³´ ë¡œë“œ
                const roomTypesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'hotel_room_types');
                const roomTypesSnapshot = await getDocs(roomTypesCollectionRef);
                const roomTypesMap = {};
                roomTypesSnapshot.forEach(doc => {
                    roomTypesMap[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                // 2. ê²€ìƒ‰ ë‚ ì§œ ë²”ìœ„ì— í•´ë‹¹í•˜ëŠ” Inventory ë¬¸ì„œ ì¡°íšŒ
                const inventoryCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'hotel_inventory');
                const inventorySnapshot = await getDocs(inventoryCollectionRef);
                
                // 3. ì¬ê³  ë° ìš”ê¸ˆ ê³„ì‚° (ê¸°ì¡´ ë¡œì§)
                const roomAvailability = {}; 
                inventorySnapshot.forEach(doc => {
                    const data = doc.data();
                    const docDate = data.date;
                    if (datesToBook.includes(docDate)) {
                        const key = `${data.roomId}_${data.partnerId}`;
                        
                        if (!roomAvailability[key]) {
                            roomAvailability[key] = {
                                roomId: data.roomId,
                                partnerId: data.partnerId,
                                roomType: roomTypesMap[data.roomId] || null, 
                                minInventory: Infinity, 
                                totalPrice: 0, 
                                datesFound: 0, 
                            };
                        }
                        roomAvailability[key].minInventory = Math.min(roomAvailability[key].minInventory, data.inventory);
                        roomAvailability[key].totalPrice += data.price;
                        roomAvailability[key].datesFound += 1;
                    }
                });

                // 4. ìµœì¢… ê²°ê³¼ í•„í„°ë§ ë° í¬ë§·íŒ…
                const finalResults = Object.values(roomAvailability)
                    .filter(item => item.roomType && item.datesFound === totalNights && item.minInventory > 0)
                    .map(item => ({
                        productType: 'accommodation',
                        id: item.roomId,
                        name: item.roomType.name,
                        partnerId: item.partnerId,
                        metadata: {
                            beds: item.roomType.beds,
                            size: item.roomType.size,
                            maxOccupancy: item.roomType.maxOccupancy,
                            remaining: item.minInventory,
                        },
                        totalPrice: item.totalPrice,
                        averagePrice: item.totalPrice / totalNights,
                        nights: totalNights
                    }))
                    .sort((a, b) => a.totalPrice - b.totalPrice); 

                renderResults(finalResults, checkInDate, checkOutDate, totalNights);
                
            } catch (error) {
                console.error("Accommodation search failed:", error);
                showMessage("ê²€ìƒ‰ ì˜¤ë¥˜", "ìˆ™ë°• ìƒí’ˆì„ ê²€ìƒ‰í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * í•­ê³µê¶Œ ìƒí’ˆ ê²€ìƒ‰ (Mock Data ì‚¬ìš© - ê¸°ì¡´ ìœ ì§€)
         */
        async function searchFlights() {
             if (!db || !userId) {
                showMessage("ì˜¤ë¥˜", "Firebase ì—°ê²° ë˜ëŠ” ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const checkInDate = document.getElementById('check-in-date').value; // ì¶œë°œì¼
            const origin = document.getElementById('origin').value;
            const flightDestination = document.getElementById('flight-destination').value;
            
            if (!checkInDate || !origin || !flightDestination) {
                showMessage("í•„ìˆ˜ ì…ë ¥", "ì¶œë°œì§€, ë„ì°©ì§€, ì¶œë°œ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const checkIn = parseDate(checkInDate);

            if (checkIn < today) {
                showMessage("ë‚ ì§œ ì˜¤ë¥˜", "ì¶œë°œ ë‚ ì§œëŠ” ì˜¤ëŠ˜ ë‚ ì§œ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            toggleLoading(true);
            
            try {
                // Mock ë°ì´í„°ì—ì„œ ê²½ë¡œì™€ ì¼ì¹˜í•˜ëŠ” í•­ê³µê¶Œì„ ì°¾ê³  ê°€ê²©ì„ ë™ì ìœ¼ë¡œ ì„¤ì •
                const routeName = `${origin.toUpperCase()} â†’ ${flightDestination.toUpperCase()}`;
                
                const finalResults = MOCK_FLIGHT_PRODUCTS
                    .filter(flight => flight.route.includes(routeName.split('â†’').map(s => s.trim()).join(' â†’ ')))
                    .map((flight, index) => {
                        const dynamicPrice = flight.basePrice + (Math.floor(Math.random() * 20000)); // ëœë¤ ê°€ê²© ë³€ë™ ì¶”ê°€
                        return {
                            productType: 'flight',
                            id: flight.id,
                            name: `${flight.airline} ${flight.flightNumber}`,
                            partnerId: flight.airline.replace(/\s/g, ''),
                            metadata: {
                                flightNumber: flight.flightNumber,
                                airline: flight.airline,
                                route: flight.route,
                                duration: flight.duration,
                                remaining: 5 + (index % 3) // ì„ì˜ì˜ ì”ì—¬ ì¢Œì„
                            },
                            totalPrice: dynamicPrice,
                            averagePrice: dynamicPrice, // 1ì¸ ê¸°ì¤€ ìš”ê¸ˆ
                            nights: null // í•­ê³µê¶Œì€ ë°•ìˆ˜ê°€ ì—†ìŒ
                        };
                    })
                    .sort((a, b) => a.totalPrice - b.totalPrice); // ìµœì €ê°€ ìˆœìœ¼ë¡œ ì •ë ¬

                renderResults(finalResults, checkInDate, null, null);
                
            } catch (error) {
                console.error("Flight search failed:", error);
                showMessage("ê²€ìƒ‰ ì˜¤ë¥˜", "í•­ê³µê¶Œ ìƒí’ˆì„ ê²€ìƒ‰í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * ë Œí„°ì¹´ ìƒí’ˆ ê²€ìƒ‰ (Mock Data ì‚¬ìš© - ê¸°ì¡´ ìœ ì§€)
         */
        async function searchRentalCars() {
             if (!db || !userId) {
                showMessage("ì˜¤ë¥˜", "Firebase ì—°ê²° ë˜ëŠ” ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const pickupDate = document.getElementById('check-in-date').value;
            const returnDate = document.getElementById('check-out-date').value;
            const pickupTime = document.getElementById('pickup-time').value;
            const returnTime = document.getElementById('return-time').value;
            const location = document.getElementById('pickup-location').value;

            if (!pickupDate || !returnDate || !pickupTime || !returnTime) {
                showMessage("í•„ìˆ˜ ì…ë ¥", "í”½ì—…/ë°˜ë‚© ë‚ ì§œ ë° ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                return;
            }
            
            const pickup = parseDate(pickupDate);
            const returnDt = parseDate(returnDate);
            
            if (pickup > returnDt) {
                 showMessage("ë‚ ì§œ ì˜¤ë¥˜", "ë°˜ë‚© ë‚ ì§œëŠ” í”½ì—… ë‚ ì§œì™€ ê°™ê±°ë‚˜ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            toggleLoading(true);
            
            const rentalDays = getDurationInDays(pickupDate, returnDate); // ì¼ ë‹¨ìœ„ ê³„ì‚°

            try {
                const finalResults = MOCK_CAR_PRODUCTS
                    .map((car, index) => {
                        // ì¼ì¼ ê°€ê²©ì— ëœë¤ ë³€ë™ì„± ì¶”ê°€
                        const dailyPrice = car.dailyPrice + (Math.floor(Math.random() * 5000) * index);
                        const totalPrice = dailyPrice * rentalDays;

                        return {
                            productType: 'rental_car',
                            id: car.id,
                            name: `${car.model}`,
                            partnerId: car.company.replace(/\s/g, ''),
                            metadata: {
                                model: car.model,
                                company: car.company,
                                fuel: car.fuel,
                                location: location,
                                pickupTime: pickupTime,
                                returnTime: returnTime,
                                remaining: 3 + (index % 3) // ì„ì˜ì˜ ì”ì—¬ ì°¨ëŸ‰
                            },
                            totalPrice: totalPrice,
                            averagePrice: dailyPrice,
                            days: rentalDays
                        };
                    })
                    .sort((a, b) => a.totalPrice - b.totalPrice); 

                renderResults(finalResults, pickupDate, returnDate, rentalDays);
                
            } catch (error) {
                console.error("Rental car search failed:", error);
                showMessage("ê²€ìƒ‰ ì˜¤ë¥˜", "ë Œí„°ì¹´ ìƒí’ˆì„ ê²€ìƒ‰í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                toggleLoading(false);
            }
        }


        // --- UI ë Œë”ë§ í•¨ìˆ˜ (í†µí•©) ---
        function renderResults(results, checkIn, checkOut, duration) { // duration can be nights or days
            const container = document.getElementById('results-container');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 text-red-800 p-4 rounded-lg">
                        <p class="font-semibold">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>
                        <p class="text-sm">ì„ íƒí•˜ì‹  ì¡°ê±´ì— ë§ëŠ” ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¡°ê±´ì„ ë³€ê²½í•´ ë³´ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }
            
            const productType = results[0]?.productType;
            const isAccommodation = productType === 'accommodation';
            const isFlight = productType === 'flight';
            const isRentalCar = productType === 'rental_car';
            const isPackage = productType === 'package';
            
            // ê²°ê³¼ í—¤ë” í…ìŠ¤íŠ¸ ì„¤ì •
            let headerText;
            let productTypeKo;
            let headerColor;

            if (isAccommodation) {
                headerText = `${checkIn} ~ ${checkOut}, ì´ ${duration}ë°•`;
                productTypeKo = 'ìˆ™ì†Œ ìƒí’ˆ';
                headerColor = 'text-indigo-700';
            } else if (isFlight) {
                headerText = `ì¶œë°œì¼: ${checkIn}`;
                productTypeKo = 'í•­ê³µê¶Œ';
                headerColor = 'text-green-700';
            } else if (isRentalCar) {
                const pickupTime = results[0]?.metadata?.pickupTime || '';
                const returnTime = results[0]?.metadata?.returnTime || '';
                headerText = `${checkIn} ${pickupTime} ~ ${checkOut} ${returnTime}, ì´ ${duration}ì¼`;
                productTypeKo = 'ë Œí„°ì¹´ ìƒí’ˆ';
                headerColor = 'text-orange-700';
            } else if (isPackage) {
                headerText = `${checkIn} ~ ${checkOut}, ì´ ${duration}ë°•`;
                productTypeKo = 'íŒ¨í‚¤ì§€ ìƒí’ˆ';
                headerColor = 'text-fuchsia-700';
            }

            const header = `
                <div class="text-gray-600 mb-4">
                    <span class="font-bold text-lg ${headerColor}">${results.length}</span>ê°œ ${productTypeKo} ë°œê²¬ë¨ (${headerText})
                </div>
            `;
            container.innerHTML = header;

            results.forEach(item => {
                const metadata = item.metadata;
                
                let productDetails = '';
                let imageText = '';
                let priceLabel;
                let priceColor;
                let ringColor;

                if (isAccommodation) {
                    priceLabel = `ì´ ${item.nights}ë°• ìš”ê¸ˆ`;
                    priceColor = 'text-indigo-600';
                    ringColor = 'hover:ring-indigo-500';
                    productDetails = `
                        <p class="text-sm text-gray-500 mb-2">${metadata.beds || 'ì •ë³´ ì—†ìŒ'} | ${metadata.size || '0'}ã¡ | ìµœëŒ€ ${metadata.maxOccupancy || '0'}ì¸</p>
                        <p class="text-sm text-green-600 font-semibold">ì”ì—¬ ê°ì‹¤: ${metadata.remaining}ê°œ</p>
                        <p class="text-xs text-gray-400 mt-1">íŒŒíŠ¸ë„ˆ ID: ${item.partnerId}</p>
                    `;
                    imageText = item.name.replace(/\s/g, '+');
                } else if (isFlight) {
                    priceLabel = '1ì¸ í¸ë„ ìš”ê¸ˆ';
                    priceColor = 'text-green-600';
                    ringColor = 'hover:ring-green-500';
                    productDetails = `
                        <p class="text-sm text-gray-500 mb-2 font-semibold">${metadata.route}</p>
                        <p class="text-sm text-gray-700">ì†Œìš” ì‹œê°„: ${metadata.duration}</p>
                        <p class="text-sm text-green-600 font-semibold">ì”ì—¬ ì¢Œì„: ${metadata.remaining}ì„</p>
                        <p class="text-xs text-gray-400 mt-1">ìš´í•­ì‚¬: ${metadata.airline}</p>
                    `;
                    imageText = metadata.airline.replace(/\s/g, '+');
                } else if (isRentalCar) {
                    priceLabel = `ì´ ${item.days}ì¼ ëŒ€ì—¬ ìš”ê¸ˆ`;
                    priceColor = 'text-orange-600';
                    ringColor = 'hover:ring-orange-500';
                     productDetails = `
                        <p class="text-sm text-gray-700 mb-2 font-semibold">ì°¨ëŸ‰ ì¢…ë¥˜: ${metadata.model} (${metadata.fuel})</p>
                        <p class="text-sm text-gray-500">í”½ì—…/ë°˜ë‚©: ${metadata.location} (${metadata.pickupTime} / ${metadata.returnTime})</p>
                        <p class="text-sm text-green-600 font-semibold">ì”ì—¬ ì°¨ëŸ‰: ${metadata.remaining}ëŒ€</p>
                        <p class="text-xs text-gray-400 mt-1">ëŒ€ì—¬ ì—…ì²´: ${metadata.company}</p>
                    `;
                    imageText = metadata.model.replace(/\s/g, '+');
                } else if (isPackage) {
                    priceLabel = `ì´ ${item.nights}ë°• íŒ¨í‚¤ì§€ ìš”ê¸ˆ`;
                    priceColor = 'text-fuchsia-600';
                    ringColor = 'hover:ring-fuchsia-500';
                    productDetails = `
                        <p class="text-sm text-gray-700 mb-1 font-semibold">âœˆï¸ í•­ê³µ: ${metadata.flightName} (${metadata.route})</p>
                        <p class="text-sm text-gray-700 mb-2 font-semibold">ğŸ¨ ìˆ™ì†Œ: ${metadata.accommodationName}</p>
                        <p class="text-sm text-gray-500">í¬í•¨ ë‚´ì—­: í•­ê³µ + ${item.nights}ë°• ìˆ™ì†Œ</p>
                        <p class="text-sm text-green-600 font-semibold">ë‚¨ì€ íŒ¨í‚¤ì§€ ìˆ˜: ${metadata.remaining}ê°œ</p>
                        <p class="text-xs text-gray-400 mt-1">íŒ¨í‚¤ì§€ ì½”ë“œ: ${item.id}</p>
                    `;
                    imageText = 'Package+Deal';
                }

                // Booking Data for the button
                const bookingData = JSON.stringify({
                    productType: item.productType,
                    productId: item.id,
                    partnerId: item.partnerId,
                    checkIn: checkIn,
                    checkOut: checkOut, 
                    nights: item.nights || null,
                    days: item.days || null, // ë Œí„°ì¹´ìš©
                    totalPrice: item.totalPrice,
                    productName: item.name,
                    metadata: metadata
                }).replace(/"/g, '&quot;');
                
                const resultCard = document.createElement('div');
                resultCard.className = `bg-white p-5 rounded-xl card-shadow flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-6 hover:ring-2 ${ringColor} transition duration-300`;
                
                let priceDetail = '';
                if (isAccommodation) {
                    priceDetail = `<p class="text-sm text-gray-400">1ë°• í‰ê·  ${item.averagePrice.toLocaleString('ko-KR')} KRW</p>`;
                } else if (isRentalCar) {
                    priceDetail = `<p class="text-sm text-gray-400">1ì¼ í‰ê·  ${item.averagePrice.toLocaleString('ko-KR')} KRW</p>`;
                } else if (isPackage) {
                     priceDetail = `<p class="text-sm text-gray-400">1ì¸ ê¸°ì¤€, ì´í•© ${item.nights}ë°•</p>`;
                }

                const cardContent = `
                    <!-- ì´ë¯¸ì§€ í”Œë ˆì´ìŠ¤í™€ë” -->
                    <div class="flex-shrink-0 w-full md:w-56 h-36 bg-gray-200 rounded-lg overflow-hidden">
                        <img src="https://placehold.co/600x400/818cf8/ffffff?text=${imageText}" 
                             alt="${item.name} ì´ë¯¸ì§€" class="w-full h-full object-cover">
                    </div>
                    
                    <!-- ìƒì„¸ ì •ë³´ -->
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-900">${item.name}</h3>
                        ${productDetails}
                    </div>

                    <!-- ê°€ê²© ë° ì˜ˆì•½ ë²„íŠ¼ -->
                    <div class="flex-shrink-0 flex flex-col items-start md:items-end justify-between">
                        <div class="text-right">
                            <p class="text-xs text-gray-500">${priceLabel}</p>
                            <p class="text-3xl font-extrabold ${priceColor}">${item.totalPrice.toLocaleString('ko-KR')} KRW</p>
                            ${priceDetail}
                        </div>
                        <div class="flex flex-col space-y-2 w-full md:w-auto mt-3">
                            <button onclick='addToCart("${bookingData}")'
                                    class="w-full bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-600 transition shadow-lg">
                                ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                            </button>
                            <button onclick='bookProduct("${bookingData}")'
                                    class="w-full bg-orange-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-orange-600 transition shadow-lg">
                                ì§€ê¸ˆ ì˜ˆì•½
                            </button>
                        </div>
                    </div>
                `;
                resultCard.innerHTML = cardContent;
                container.appendChild(resultCard);
            });
        }
        
        /**
         * ì˜ˆì•½ ìš”ì²­ ì²˜ë¦¬ ë° Firestoreì— ì €ì¥ (í†µí•©)
         * @param {string} bookingDataJson - ì˜ˆì•½ ìƒì„¸ ì •ë³´ JSON ë¬¸ìì—´
         * @param {boolean} [isFromCart=false] - ì¥ë°”êµ¬ë‹ˆì—ì„œ ì˜ˆì•½í–ˆëŠ”ì§€ ì—¬ë¶€
         * @param {number} [cartIndex] - ì¥ë°”êµ¬ë‹ˆ ì¸ë±ìŠ¤ (ì¥ë°”êµ¬ë‹ˆì—ì„œ ì˜ˆì•½ ì‹œ)
         */
        window.bookProduct = async (bookingDataJson, isFromCart = false, cartIndex = -1) => {
            if (!userId) {
                showMessage("ì˜ˆì•½ ë¶ˆê°€", "ì‚¬ìš©ì ì¸ì¦ì— ì‹¤íŒ¨í•˜ì—¬ ì˜ˆì•½ì„ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            if (!db) {
                showMessage("ì˜¤ë¥˜", "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                const bookingDetails = JSON.parse(bookingDataJson);
                
                const bookingsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'bookings');
                
                const newBooking = {
                    ...bookingDetails,
                    userId: userId,
                    bookingDate: formatDate(new Date()),
                    status: 'PENDING',
                };
                
                // ë¶ˆí•„ìš”í•œ ì¤‘ë³µ metadata ì œê±°
                delete newBooking.metadata.remaining;
                
                const docRef = await addDoc(bookingsCollectionRef, newBooking);

                const isFlight = bookingDetails.productType === 'flight';
                const isRentalCar = bookingDetails.productType === 'rental_car';
                const isPackage = bookingDetails.productType === 'package';
                
                let productTypeKo = isPackage ? 'íŒ¨í‚¤ì§€' : isAccommodation ? 'ìˆ™ë°•' : isFlight ? 'í•­ê³µê¶Œ' : 'ë Œí„°ì¹´';
                let successMessage;

                if (isFromCart && cartIndex > -1) {
                    removeFromCart(cartIndex); // ì¥ë°”êµ¬ë‹ˆì—ì„œ ì˜ˆì•½ ì™„ë£Œ ì‹œ ì‚­ì œ
                }

                if (isPackage) {
                    successMessage = `[${bookingDetails.productName}] íŒ¨í‚¤ì§€ ì˜ˆì•½ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê²°ì œ ê¸ˆì•¡: ${bookingDetails.totalPrice.toLocaleString('ko-KR')} KRW`;
                } else if (isFlight) {
                    successMessage = `[${bookingDetails.productName}] í•­ê³µê¶Œ ì˜ˆì•½ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê²°ì œ ê¸ˆì•¡: ${bookingDetails.totalPrice.toLocaleString('ko-KR')} KRW`;
                } else if (isRentalCar) {
                    successMessage = `[${bookingDetails.productName}] ë Œí„°ì¹´ ì˜ˆì•½ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. í”½ì—… ê¸°ê°„: ${bookingDetails.days}ì¼. ì´ ê²°ì œ ê¸ˆì•¡: ${bookingDetails.totalPrice.toLocaleString('ko-KR')} KRW`;
                } else {
                     successMessage = `[${bookingDetails.productName}] ìƒí’ˆì— ëŒ€í•œ ${bookingDetails.nights}ë°• ì˜ˆì•½ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê²°ì œ ê¸ˆì•¡: ${bookingDetails.totalPrice.toLocaleString('ko-KR')} KRW`;
                }

                showMessage(
                    `ğŸ‰ ${productTypeKo} ì˜ˆì•½ ìš”ì²­ ì„±ê³µ!`,
                    successMessage + `\n\nì˜ˆì•½ ID: ${docRef.id.substring(0, 8)}...`
                );
                
                showView('bookings');

            } catch (error) {
                console.error("Booking failed:", error);
                showMessage("ì˜ˆì•½ ì‹¤íŒ¨", "ì˜ˆì•½ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        };


        // --- Firebase Initialization and Authentication ---
        async function initFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        console.log("Customer Portal Auth Success. User ID:", userId);
                        
                        showView('search');
                        setSearchType('package'); 
                        updateCartCount(); // Initial cart count
                    } else {
                        userId = null;
                        document.getElementById('user-id-display').textContent = 'ì¸ì¦ë˜ì§€ ì•ŠìŒ';
                        console.warn("User signed out or failed to authenticate anonymously.");
                        if (unsubscribeBookings) {
                            unsubscribeBookings();
                            unsubscribeBookings = null;
                        }
                    }
                });
                
                initializeUI();

            } catch (error) {
                console.error("Firebase initialization or auth failed:", error);
                showMessage("Firebase ì˜¤ë¥˜", `Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }
        
        // --- UI ì´ˆê¸°í™” ë° ë‚ ì§œ ì„¤ì • ---
        function initializeUI() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            const formatDate = (date) => date.toISOString().split('T')[0];
            const tomorrowStr = formatDate(tomorrow);
            const dayAfterTomorrowStr = formatDate(new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000));

            // ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œëŠ” ì„ íƒ ë¶ˆê°€í•˜ë„ë¡ min ì†ì„± ì„¤ì •
            document.getElementById('check-in-date').min = tomorrowStr;
            document.getElementById('check-out-date').min = dayAfterTomorrowStr; 

            // ì´ˆê¸° ë‚ ì§œ ê°’ ì„¤ì • (1ë°•/2ì¼ íŒ¨í‚¤ì§€ ê¸°ë³¸)
            document.getElementById('check-in-date').value = tomorrowStr;
            document.getElementById('check-out-date').value = dayAfterTomorrowStr;
        }


        // --- Initial Setup ---
        window.onload = initFirebase;

    </script>
</body>
</html>